generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rooms         Room[]
  agents        Agent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  tasks         Task[]
  settings      Setting[]
  agentRuns     AgentRun[]
  prdsCreated   Prd[] @relation("PrdCreatedBy")
  knowledgeCreated KnowledgeItem[] @relation("KnowledgeCreatedByUser")
}

model Room {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  paused      Boolean  @default(false)
  userId      String?
  publicShareId       String?  @unique
  publicShareEnabledAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agents        RoomAgent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  tasks         Task[]
  prds          Prd[]
  knowledge     KnowledgeItem[]
  agentRuns     AgentRun[]
  workItems     WorkItem[]
  orchestrations AgentOrchestration[]
}

model Agent {
  id            String   @id @default(cuid())
  name          String
  color         String   @default("#3B82F6")
  icon          String   @default("robot")
  repoUrl       String   @default("")
  harness       String   @default("claude-code")
  environmentId String   @default("")
  systemPrompt  String   @default("")
  skills        String   @default("[]")
  mcpServers    String   @default("[]")
  scripts       String   @default("[]")
  status        String   @default("idle")
  activeRoomId  String?  
  userId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms         RoomAgent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  agentRuns     AgentRun[]
  workItems     WorkItem[]
  assignedTasks Task[]   @relation("TaskAssignee")
  createdTasks  Task[]   @relation("TaskCreator")
  ledOrchestrations AgentOrchestration[]
  orchestrationChildren AgentOrchestrationChild[]
  knowledgeCreated KnowledgeItem[] @relation("KnowledgeCreatedByAgent")
}

model RoomAgent {
  id      String @id @default(cuid())
  roomId  String
  agentId String

  room  Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([roomId, agentId])
}

model Message {
  id         String   @id @default(cuid())
  roomId     String
  authorId   String?
  authorType String   @default("human")
  content    String
  sessionUrl String?
  userId     String?
  timestamp  DateTime @default(now())

  room  Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent? @relation(fields: [authorId], references: [id], onDelete: SetNull)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([roomId, userId])
}

model Artifact {
  id        String   @id @default(cuid())
  roomId    String
  type      String
  title     String
  content   String   @default("")
  url       String?
  createdBy String?
  userId    String?
  createdAt DateTime @default(now())

  room  Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent? @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([roomId, userId])
}

model Notification {
  id        String   @id @default(cuid())
  roomId    String
  agentId   String
  message   String
  read      Boolean  @default(false)
  userId    String?
  timestamp DateTime @default(now())

  room  Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id          String   @id @default(cuid())
  roomId      String
  title       String
  description String   @default("")
  status      String   @default("backlog")
  priority    String   @default("medium")
  assigneeId  String?
  createdBy   String?
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  room     Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  assignee Agent? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  creator  Agent? @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  user     User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  workItems WorkItem[]

  @@index([roomId, userId])
}
model AgentOrchestration {
  id            String   @id @default(cuid())
  roomId        String
  leadAgentId   String
  leadRunId     String   @unique
  status        String   @default("running")
  deadlineAt    DateTime?
  followupRunId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  room      Room                      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  leadAgent Agent                     @relation(fields: [leadAgentId], references: [id], onDelete: Cascade)
  children  AgentOrchestrationChild[]
}

model AgentOrchestrationChild {
  id              String   @id @default(cuid())
  orchestrationId String
  agentId         String
  runId           String   @unique
  status          String   @default("dispatched")
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  orchestration AgentOrchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)
  agent         Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([orchestrationId, agentId])
  @@index([orchestrationId])
}

model AgentCallback {
  id        String   @id
  response  String
  createdAt DateTime @default(now())
}

model Setting {
  id     String @id @default(cuid())
  key    String
  value  String
  userId String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
}

// Local/remote agent run tracking. In local mode, `id` is the invocationId.
// In remote mode, `id` is also the invocationId, and `remoteRunId` stores the provider control-plane run id.
model AgentRun {
  id          String   @id
  roomId      String
  agentId     String
  userId      String?

  title       String
  prompt      String

  harness     String
  providerKey String
  providerType String
  model       String
  remoteRunId String?

  state       String   @default("QUEUED") // QUEUED|INPROGRESS|SUCCEEDED|FAILED|CANCELLED
  errorMessage String?

  queuedAt    DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  updatedAt   DateTime @updatedAt

  room  Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([roomId])
  @@index([agentId])
  @@index([userId])
  @@index([userId, state])
  @@index([state])
}

// Simple rolling-window quota tracker for local provider routing.
model ProviderUsage {
  userId          String   @default("global")
  providerKey     String
  windowStartedAt DateTime
  windowSeconds   Int
  messagesUsed    Int
  messagesLimit   Int
  updatedAt       DateTime @updatedAt

  @@id([userId, providerKey])
  @@index([userId])
  @@index([providerKey])
}

model Prd {
  id        String   @id @default(cuid())
  title     String
  content   String   @default("") // markdown
  status    String   @default("DRAFT") // DRAFT|DECOMPOSING|ACTIVE|COMPLETED
  roomId    String
  createdBy String?  // User.id (nullable for future automation)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room      Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  creator   User?  @relation("PrdCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  epics     Epic[]
  knowledgeItems KnowledgeItem[]

  @@index([roomId])
  @@index([status])
  @@index([createdBy])
}

model Epic {
  id        String   @id @default(cuid())
  prdId     String
  title     String
  status    String   @default("ACTIVE") // ACTIVE|COMPLETED
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prd       Prd      @relation(fields: [prdId], references: [id], onDelete: Cascade)
  workItems WorkItem[]

  @@index([prdId])
  @@index([status])
  @@index([prdId, order])
}

model KnowledgeItem {
  id               String   @id @default(cuid())
  roomId           String
  kind             String   @default("learning") // learning|pattern|gotcha|decision
  title            String
  content          String   @default("") // markdown/plaintext
  tagsJson         String   @default("[]") // JSON array of strings
  sourcePrdId      String?
  sourceWorkItemId String?
  createdByUserId  String?
  createdByAgentId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  room             Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sourcePrd        Prd?   @relation(fields: [sourcePrdId], references: [id], onDelete: SetNull)
  sourceWorkItem   WorkItem? @relation("KnowledgeSourceWorkItem", fields: [sourceWorkItemId], references: [id], onDelete: SetNull)
  createdByUser    User?  @relation("KnowledgeCreatedByUser", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdByAgent   Agent? @relation("KnowledgeCreatedByAgent", fields: [createdByAgentId], references: [id], onDelete: SetNull)

  @@index([roomId])
  @@index([kind])
  @@index([sourcePrdId])
  @@index([sourceWorkItemId])
  @@index([createdByUserId])
  @@index([createdByAgentId])
}

// Orchestrator queue items (PM layer "driver"). Kept separate from UI-facing Tasks.
model WorkItem {
  id             String   @id @default(cuid())
  type           String
  status         String   @default("QUEUED") // QUEUED|CLAIMED|RUNNING|SUCCEEDED|FAILED|CANCELLED
  payload        String   @default("{}")     // JSON-encoded payload (string to keep SQLite/libsql compatibility)

  chainId        String?
  sourceItemId   String?
  iteration      Int      @default(0)
  maxIterations  Int      @default(3)

  roomId         String?
  agentId        String?
  sourceTaskId   String?
  epicId         String?

  claimedAt      DateTime?
  leaseExpiresAt DateTime?
  // Identifies which orchestrator instance currently "owns" this lease. Used to prevent
  // stale/overlapping updates when multiple orchestrators are running.
  leaseOwner     String?
  runId          String? // invocationId used with invokeAgent (stable id for correlation)

  attempts       Int      @default(0)
  maxAttempts    Int      @default(3)
  lastError      String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  room        Room? @relation(fields: [roomId], references: [id], onDelete: SetNull)
  agent       Agent? @relation(fields: [agentId], references: [id], onDelete: SetNull)
  sourceTask  Task? @relation(fields: [sourceTaskId], references: [id], onDelete: SetNull)
  epic        Epic? @relation(fields: [epicId], references: [id], onDelete: SetNull)
  knowledgeItems KnowledgeItem[] @relation("KnowledgeSourceWorkItem")

  @@index([status, leaseExpiresAt])
  @@index([leaseOwner])
  @@index([chainId])
  @@index([sourceItemId])
  @@index([chainId, iteration])
  @@index([roomId])
  @@index([agentId])
  @@index([sourceTaskId])
  @@index([epicId])
}
