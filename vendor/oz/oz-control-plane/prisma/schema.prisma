generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model AgentRun {
  id           String   @id
  ownerKeyHash String

  title        String
  prompt       String
  environmentId String?
  workerId     String?
  sessionLink  String?
  artifactsJson String?

  harness      String
  providerKey  String
  providerType String
  model        String
  remoteRunId  String?

  state        String   @default("QUEUED") // QUEUED|INPROGRESS|SUCCEEDED|FAILED|CANCELLED
  output       String   @default("")
  errorMessage String?

  queuedAt     DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  updatedAt    DateTime @updatedAt

  @@index([ownerKeyHash])
  @@index([ownerKeyHash, state])
  @@index([state])
  @@index([queuedAt])
}

model ProviderUsage {
  ownerKeyHash    String
  providerKey     String
  windowStartedAt DateTime
  windowSeconds   Int
  messagesUsed    Int
  messagesLimit   Int

  @@id([ownerKeyHash, providerKey])
  @@index([ownerKeyHash])
  @@index([providerKey])
}

model Environment {
  id                String   @id
  ownerKeyHash      String?
  name              String
  dockerImage       String
  reposText         String   @default("") // newline-separated
  setupCommandsText String   @default("") // newline-separated
  envVarsText       String   @default("") // newline-separated KEY=VALUE
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ownerKeyHash])
  @@index([name])
}
